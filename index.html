<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaborTrack</title>
    <!-- Favicon link corrected -->
    <link rel="icon" type="image/png" href="https://icons.iconarchive.com/icons/pictogrammers/material/24/clock-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        info: '#3B82F6',
                    }
                }
            }
        }
    </script>
    <style>
        /* --- Base Styles --- */
        body {
        	font-family: -apple-system, BlinkMacSystemFont, "Inter", "Arial", sans-serif;
        }

        /* --- Animations --- */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Sidebar Styles --- */
        .sidebar { transition: all 0.3s ease-in-out; }
        
        /* Desktop collapsed state */
        .sidebar.collapsed { width: 4.5rem; /* 72px */ }
        .sidebar.collapsed .nav-text, .sidebar.collapsed .logo-text { display: none; }
        .sidebar.collapsed .expand-icon { transform: rotate(180deg); }
        
        /* Mobile sidebar state */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 50;
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            #sidebar-overlay {
                transition: opacity 0.3s ease-in-out;
            }
        }
        
        .sidebar a.active { color: #4F46E5; background-color: rgba(79, 70, 229, 0.1); }
        html.dark .sidebar a.active { color: #818cf8; background-color: rgba(129, 140, 248, 0.1); }

        /* --- Chart and Modal Styles --- */
        .chart-container { position: relative; height: 300px; width: 100%; }
        .modal { transition: opacity 0.25s ease; }
        
        /* Prevent background scroll when modal is open */
        body.modal-open {
            overflow: hidden;
        }
        
        #uploadNotification { transition: opacity 0.3s, transform 0.3s; }

        /* --- KPI Button Styles --- */
        .kpi-time-btn.active {
            background-color: #ffffff;
            color: #4F46E5;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        html.dark .kpi-time-btn.active {
            background-color: #374151; /* gray-700 */
            color: #818cf8;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans">
    <!-- Login View -->
    <div id="loginView" class="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900 p-4">
        <div class="w-full max-w-md p-8 space-y-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
            <div class="text-center">
                <i class="fas fa-clock text-primary text-5xl mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Welcome to LaborTrack</h2>
                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Sign in to continue</p>
            </div>
            <form id="loginForm" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <input id="email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white rounded-t-md focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white rounded-b-md focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>
                <div id="authError" class="text-red-500 text-sm text-center hidden"></div>
                <div>
                    <button type="submit" id="loginButton" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Sign in
                    </button>
                </div>
            </form>
            <div class="text-sm text-center">
                <p class="text-gray-600 dark:text-gray-400">Don't have an account?
                    <a href="#" id="showSignUp" class="font-medium text-primary hover:text-indigo-500">Sign up</a>
                </p>
            </div>
        </div>
    </div>

    <!-- App View -->
    <div id="appView" class="hidden h-screen overflow-hidden">
        <div class="flex h-full">
            <!-- Sidebar Overlay for mobile -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>
            
            <!-- Sidebar -->
            <div id="sidebar" class="sidebar bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 shadow-lg flex flex-col w-64">
                <div class="p-4 flex items-center justify-between border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center"><i class="fas fa-clock text-primary text-2xl mr-3"></i><span class="logo-text font-bold text-xl">LaborTrack</span></div>
                    <!-- This button is for desktop sidebar collapse -->
                    <button id="toggleSidebar" class="expand-icon text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-transform hidden md:block"><i class="fas fa-chevron-left"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto py-4">
                    <div class="px-4 mb-6">
                        <h3 class="text-xs uppercase font-semibold text-gray-500 dark:text-gray-400 mb-3">Main</h3>
                        <ul id="main-nav">
                            <li><a href="#" data-view="dashboardView" class="flex items-center px-3 py-2 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-indigo-400 hover:bg-primary hover:bg-opacity-10 rounded-lg"><i class="fas fa-tachometer-alt w-6 text-center mr-3"></i><span class="nav-text">Dashboard</span></a></li>
                            <li class="mt-2"><a href="#" data-view="employeeTableView" class="flex items-center px-3 py-2 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-indigo-400 hover:bg-primary hover:bg-opacity-10 rounded-lg"><i class="fas fa-users w-6 text-center mr-3"></i><span class="nav-text">Employees</span></a></li>
                            <li class="mt-2"><a href="#" data-view="performanceView" class="flex items-center px-3 py-2 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-indigo-400 hover:bg-primary hover:bg-opacity-10 rounded-lg"><i class="fas fa-bullseye w-6 text-center mr-3"></i><span class="nav-text">Performance</span></a></li>
                            <li class="mt-2"><a href="#" data-view="reportsView" class="flex items-center px-3 py-2 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-indigo-400 hover:bg-primary hover:bg-opacity-10 rounded-lg"><i class="fas fa-chart-pie w-6 text-center mr-3"></i><span class="nav-text">Reports</span></a></li>
                        </ul>
                    </div>
                    <div class="px-4 mb-6">
                        <h3 class="text-xs uppercase font-semibold text-gray-500 dark:text-gray-400 mb-3">Tools</h3>
                        <ul>
                            <li><label for="excel_file" class="flex items-center px-3 py-2 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-indigo-400 hover:bg-primary hover:bg-opacity-10 rounded-lg cursor-pointer"><i class="fas fa-file-upload w-6 text-center mr-3"></i><span class="nav-text">Upload Data</span></label><input type="file" id="excel_file" accept=".xlsx, .xls" class="hidden"></li>
                            <li class="mt-2"><a href="#" data-view="settingsView" class="flex items-center px-3 py-2 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-indigo-400 hover:bg-primary hover:bg-opacity-10 rounded-lg"><i class="fas fa-cog w-6 text-center mr-3"></i><span class="nav-text">Settings</span></a></li>
                        </ul>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                         <div class="flex items-center">
                            <div class="nav-text">
                                <p id="userEmail" class="text-sm font-medium truncate"></p>
                            </div>
                        </div>
                        <button id="logoutButton" class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-indigo-400"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div id="mainContent" class="flex-1 flex flex-col overflow-auto">
                <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-30">
                    <div class="px-4 sm:px-6 py-4 flex items-center justify-between">
                        <div class="flex items-center">
                            <!-- Hamburger menu button for mobile -->
                            <button id="mobileMenuButton" class="md:hidden mr-4 text-gray-500 dark:text-gray-400">
                                <i class="fas fa-bars text-xl"></i>
                            </button>
                            <h1 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-white" id="pageTitle">Dashboard</h1>
                        </div>
                        <div class="flex items-center space-x-2 sm:space-x-4">
                            <div class="relative">
                                <input type="text" id="searchInput" placeholder="Search..." class="w-32 sm:w-64 pl-10 pr-4 py-2 border rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm sm:text-base">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                                <svg id="theme-toggle-dark-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                                <svg id="theme-toggle-light-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                    </div>
                </header>
                <main class="p-4 sm:p-6 flex-1 overflow-y-auto">
                    <!-- Dashboard View -->
                    <div id="dashboardView" class="view-container fade-in">
                        <div class="flex justify-end mb-4">
                            <select id="monthSelector" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white"></select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><div class="flex items-center justify-between"><div><p id="totalEmployeesLabel" class="text-gray-500 dark:text-gray-400 text-sm">Total Employees</p><h3 id="totalEmployees" class="text-2xl font-bold mt-1 text-gray-900 dark:text-white">0</h3></div><div class="p-3 rounded-full bg-primary bg-opacity-10 text-primary"><i class="fas fa-users text-xl"></i></div></div></div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><div class="flex items-center justify-between"><div><p id="totalHoursLabel" class="text-gray-500 dark:text-gray-400 text-sm">Total Hours</p><h3 id="totalHours" class="text-2xl font-bold mt-1 text-gray-900 dark:text-white">0</h3></div><div class="p-3 rounded-full bg-secondary bg-opacity-10 text-secondary"><i class="fas fa-clock text-xl"></i></div></div></div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><div class="flex items-center justify-between"><div><p id="totalBillableLabel" class="text-gray-500 dark:text-gray-400 text-sm">Total Billable</p><h3 id="totalBillable" class="text-2xl font-bold mt-1 text-gray-900 dark:text-white">$0</h3></div><div class="p-3 rounded-full bg-info bg-opacity-10 text-info"><i class="fas fa-dollar-sign text-xl"></i></div></div></div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><div class="flex items-center justify-between"><div><p id="overtimeHoursLabel" class="text-gray-500 dark:text-gray-400 text-sm">Overtime Hours</p><h3 id="overtimeHours" class="text-2xl font-bold mt-1 text-gray-900 dark:text-white">0</h3></div><div class="p-3 rounded-full bg-danger bg-opacity-10 text-danger"><i class="fas fa-exclamation-triangle text-xl"></i></div></div></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><h3 class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Daily Hours Trend</h3><div class="chart-container"><canvas id="monthlyTrendChart"></canvas></div></div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                                <h3 id="leaderboardTitle" class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Daily Hours Leaderboard</h3>
                                <ul id="leaderboardList" class="space-y-3">
                                    <!-- Leaderboard items will be dynamically inserted here -->
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Employee Table View -->
                    <div id="employeeTableView" class="view-container hidden fade-in">
                        <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-sm">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                                <h3 id="employeeTableHeader" class="font-semibold text-lg text-gray-900 dark:text-white">All Employees</h3>
                                <button id="addEmployeeBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-indigo-700 w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Add Employee</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Employee</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase hidden sm:table-cell">Department</th>
                                            <th id="employeeTableHoursHeader" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Hours</th>
                                            <th id="employeeTableBillableHeader" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase hidden md:table-cell">Billable</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employeeTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Employee Profile View -->
                    <div id="employeeProfileView" class="view-container hidden fade-in">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
                            <div class="flex items-center">
                               <button id="backToEmployeeList" class="mr-4 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-arrow-left text-gray-600 dark:text-gray-300"></i></button>
                               <h2 id="employeeNameTitle" class="text-2xl font-bold text-gray-800 dark:text-white">Employee Profile</h2>
                            </div>
                             <div class="flex flex-wrap items-center gap-2 sm:gap-4 w-full sm:w-auto">
                                <button id="editProfileBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm flex-grow sm:flex-grow-0"><i class="fas fa-edit mr-2"></i>Edit</button>
                                <button id="deleteProfileBtn" class="bg-danger text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm flex-grow sm:flex-grow-0"><i class="fas fa-trash mr-2"></i>Delete</button>
                                <select id="employeeMonthSelector" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white w-full sm:w-auto mt-2 sm:mt-0"></select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><div class="flex flex-col items-center text-center"><h3 id="employeeProfileName" class="text-xl font-bold text-gray-800 dark:text-white">-</h3><p id="employeeProfileDept" class="text-gray-600 dark:text-gray-400 mb-4">-</p><div class="w-full border-t border-gray-200 dark:border-gray-700 pt-4 text-left text-sm"><div class="flex justify-between py-1"><span class="text-gray-500 dark:text-gray-400">Employee ID</span><span id="employeeProfileId" class="font-medium text-gray-900 dark:text-white">-</span></div><div class="flex justify-between py-1"><span class="text-gray-500 dark:text-gray-400">Email</span><span id="employeeProfileEmail" class="font-medium text-gray-900 dark:text-white truncate">-</span></div></div></div></div>
                            <div class="lg:col-span-2 space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><p id="employeeHoursLabel" class="text-gray-500 dark:text-gray-400 text-sm">Hours</p><h3 id="employeeHoursThisMonth" class="text-3xl font-bold mt-1 text-gray-900 dark:text-white">0</h3></div>
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><p id="employeeBillableLabel" class="text-gray-500 dark:text-gray-400 text-sm">Billable</p><h3 id="employeeBillableThisMonth" class="text-3xl font-bold mt-1 text-gray-900 dark:text-white">$0</h3></div>
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><p id="employeeAvgHoursLabel" class="text-gray-500 dark:text-gray-400 text-sm">Avg Daily Hours</p><h3 id="employeeAvgHoursThisMonth" class="text-3xl font-bold mt-1 text-gray-900 dark:text-white">0</h3></div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><h3 class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Daily Hours</h3><div class="chart-container"><canvas id="dailyHoursChart"></canvas></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance View -->
                    <div id="performanceView" class="view-container hidden fade-in">
                        <div class="space-y-8">
                             <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                                <h3 class="font-semibold text-lg text-gray-900 dark:text-white mb-4">Key Performance Indicator Framework</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Key Accountability</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Performance Measure (KPI)</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Target</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Weight</th>
                                            </tr>
                                        </thead>
                                        <tbody id="kpiReferenceTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700 text-sm text-gray-800 dark:text-gray-200">
                                            <!-- KPI data will be injected here by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                                <h3 class="font-semibold text-lg text-gray-900 dark:text-white mb-4">Employee Performance Analysis</h3>
                                <div class="flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-4 sm:gap-8 mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
                                    <div class="w-full sm:w-auto">
                                        <label for="kpiEmployeeSelector" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Employee:</label>
                                        <select id="kpiEmployeeSelector" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white w-full sm:max-w-xs"></select>
                                    </div>
                                    <div class="w-full sm:w-auto">
                                        <label for="kpiMonthSelector" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Month:</label>
                                        <select id="kpiMonthSelector" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white w-full sm:max-w-xs"></select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time Frame:</label>
                                        <div id="kpiTimeFrameSelector" class="flex items-center rounded-lg bg-gray-100 dark:bg-gray-900 p-1">
                                            <button data-value="monthly" class="kpi-time-btn px-4 py-1.5 text-sm font-medium rounded-md">Monthly</button>
                                            <button data-value="quarterly" class="kpi-time-btn px-4 py-1.5 text-sm font-medium rounded-md">Quarterly</button>
                                        </div>
                                    </div>
                                </div>

                                <div id="employeeKpiContainer" class="space-y-4">
                                     <p class="text-gray-500 dark:text-gray-400 text-center py-8">Select an employee to view their performance analysis.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports View -->
                    <div id="reportsView" class="view-container hidden fade-in">
                        <div class="space-y-8">
                            <!-- Monthly Report -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                                <h3 class="font-semibold text-lg text-gray-900 dark:text-white mb-4">Monthly Average Hours Report</h3>
                                <div id="monthlyReportContainer" class="overflow-x-auto">
                                    <p class="text-gray-500 dark:text-gray-400">Please select a month from the dashboard and ensure all days are imported to generate this report.</p>
                                </div>
                            </div>

                            <!-- Bi-Weekly Report -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                                <h3 class="font-semibold text-lg text-gray-900 dark:text-white mb-4">Bi-Weekly Average Hours Report</h3>
                                <div id="biWeeklyReportContainer" class="overflow-x-auto">
                                    <p class="text-gray-500 dark:text-gray-400">This report shows the average daily hours for each employee over two-week periods.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings View -->
                    <div id="settingsView" class="view-container hidden fade-in">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                            <h3 class="font-semibold text-lg text-gray-900 dark:text-white">Account Settings</h3>
                            <div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Last Sign-In: <span id="lastLoginTime" class="font-medium text-gray-800 dark:text-white"></span></p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Version: <span class="font-medium text-gray-800 dark:text-white">1.6</span></p>
                            </div>
                            <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6">
                                <h4 class="font-medium text-gray-800 dark:text-white">Change Password</h4>
                                <form id="changePasswordForm" class="mt-4 space-y-4 max-w-sm">
                                    <div>
                                        <label for="newPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">New Password</label>
                                        <input type="password" id="newPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Confirm New Password</label>
                                        <input type="password" id="confirmPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm text-gray-900 dark:text-white">
                                    </div>
                                    <div id="passwordChangeStatus" class="text-sm text-center"></div>
                                    <div>
                                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                            Update Password
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Employee Edit Modal -->
    <div id="employeeModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-1/2 -translate-y-1/2 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3 text-center">
                <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Add Employee</h3>
                <form id="employeeForm" class="mt-2 text-left space-y-4">
                    <input type="hidden" id="employeeDbIdInput">
                    <div>
                        <label for="employeeIdInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Employee ID</label>
                        <input type="number" id="employeeIdInput" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="employeeNameInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                        <input type="text" id="employeeNameInput" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="employeeEmailInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                        <input type="email" id="employeeEmailInput" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="employeeDeptInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Department</label>
                        <input type="text" id="employeeDeptInput" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm text-gray-900 dark:text-white">
                    </div>
                     <div class="items-center gap-4 py-3">
                        <button type="submit" class="w-full bg-primary text-white p-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                            Save Employee
                        </button>
                        <button id="closeModal" type="button" class="w-full bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 p-2 mt-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Upload Notification Popup -->
    <div id="uploadNotification" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white text-sm font-medium z-50 opacity-0">
        <span id="uploadNotificationMessage"></span>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyA4am309Xlaz7GWZlOzUK7cEN4NE26nBNA",
            authDomain: "hermont-tire-labortrack-cloud.firebaseapp.com",
            projectId: "hermont-tire-labortrack-cloud",
            storageBucket: "hermont-tire-labortrack-cloud.appspot.com",
            messagingSenderId: "448794791885",
            appId: "1:448794791885:web:f10b9c1127d217f87abe84"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const dataDocRef = doc(db, "sharedData", "main"); // Shared data location for all users

        // --- GLOBAL STATE ---
        let monthlyTrendChart, dailyHoursChart;
        let processedData = {};
        const views = document.querySelectorAll('.view-container');
        const navLinks = document.querySelectorAll('#main-nav a, [data-view="settingsView"]');
        const employeeModal = document.getElementById('employeeModal');
        const employeeForm = document.getElementById('employeeForm');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        let notificationTimeout;

        // --- KPI Data ---
        const kpis = [
            { category: 'Vehicle Repair & Maintenance', measure: 'First-time fix rate', target: '≥ 90%', weight: '10%', key: 'fixRate' },
            { category: 'Vehicle Repair & Maintenance', measure: 'Repair accuracy (low rework rate)', target: '≤ 5% rework', weight: '5%', key: 'reworkRate' },
            { category: 'Vehicle Repair & Maintenance', measure: 'Jobs completed per shift', target: '4–6', weight: '5%', key: 'jobsPerShift' },
            { category: 'Vehicle Repair & Maintenance', measure: 'Service completion time vs standard', target: 'Within 90% of labor guide times', weight: '5%', key: 'completionTime' },
            { category: 'Vehicle Repair & Maintenance', measure: 'Billable hours per month', target: '≥ 140 hours', weight: '5%', key: 'billableHours' },
            { category: 'Documentation & Reporting', measure: 'Accuracy of service documentation', target: '100% accuracy', weight: '5%', key: 'docAccuracy' },
            { category: 'Documentation & Reporting', measure: 'Time to submit after job completion', target: 'Within 1 hour', weight: '5%', key: 'submitTime' },
            { category: 'Equipment & Vehicle Management', measure: 'Tool/equipment loss or damage incidents', target: 'Zero', weight: '5%', key: 'toolLoss' },
            { category: 'Equipment & Vehicle Management', measure: 'Compliance with equipment checks', target: '100%', weight: '5%', key: 'equipChecks' },
            { category: 'Equipment & Vehicle Management', measure: 'Inventory restocking adherence', target: '95%+ inventory match', weight: '5%', key: 'inventoryMatch' },
            { category: 'Time & Route Efficiency', measure: 'On-time arrival rate', target: '≥ 95%', weight: '5%', key: 'onTimeArrival' },
            { category: 'Time & Route Efficiency', measure: 'Jobs completed within time windows', target: '≥ 90%', weight: '5%', key: 'jobsInWindow' },
            { category: 'Time & Route Efficiency', measure: 'Travel time vs productive time', target: '< 30% travel time', weight: '5%', key: 'travelTime' },
            { category: 'Parts Preparation & Packing', measure: 'Packing accuracy', target: '≥ 98%', weight: '5%', key: 'packingAccuracy' },
            { category: 'Parts Preparation & Packing', measure: 'Job delay due to parts issues', target: '≤ 2 per month', weight: '5%', key: 'partsDelay' },
            { category: 'Parts Preparation & Packing', measure: 'Time spent on parts prep', target: '≤ 15 minutes per job', weight: '5%', key: 'partsPrepTime' },
            { category: 'Parts Preparation & Packing', measure: 'Adherence to parts checklist', target: '100%', weight: '5%', key: 'partsChecklist' },
            { category: 'Technical Growth', measure: 'Training hours completed', target: '≥ 8 hours/quarter', weight: '5%', key: 'trainingHours' },
            { category: 'Technical Growth', measure: 'Certifications maintained', target: 'All required + 1', weight: '5%', key: 'certifications' },
            { category: 'Sales & Upselling', measure: 'Additional revenue per visit', target: 'Company-specific target', weight: '5%', key: 'upsellRevenue' },
            { category: 'Sales & Upselling', measure: 'Conversion rate on recommended services', target: '≥ 30%', weight: '5%', key: 'upsellConversion' }
        ];

        // --- UI NOTIFICATIONS ---
        function showUploadNotification(message, isError = false, isWarning = false) {
            const notification = document.getElementById('uploadNotification');
            const messageEl = document.getElementById('uploadNotificationMessage');

            if (notificationTimeout) clearTimeout(notificationTimeout);

            messageEl.textContent = message;

            notification.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'hidden', 'opacity-0');
            
            let bgColor = 'bg-green-500';
            if (isError) bgColor = 'bg-red-500';
            if (isWarning) bgColor = 'bg-yellow-500'; // Using Tailwind's yellow for warnings
            notification.classList.add(bgColor);
            
            // Force reflow to restart animation
            void notification.offsetWidth; 
            
            notification.classList.add('opacity-100');

            const duration = isWarning ? 8000 : 5000; // Longer duration for warnings
            notificationTimeout = setTimeout(() => {
                notification.classList.remove('opacity-100');
                setTimeout(() => notification.classList.add('hidden'), 300); // Hide after transition
            }, duration);
        }
        
        // --- DATE HELPERS (UTC compliant) ---
        const getStartOfWeek = (date) => {
            const d = new Date(date);
            d.setUTCHours(0, 0, 0, 0);
            const day = d.getUTCDay();
            const diff = d.getUTCDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setUTCDate(diff));
        };

        const getWeekId = (date) => {
            if (!date || isNaN(new Date(date).getTime())) return null;
            const startOfWeek = getStartOfWeek(date);
            return startOfWeek.toISOString().split('T')[0];
        };

        const getMonthId = (date) => {
            if (!date || isNaN(new Date(date).getTime())) return null;
            const d = new Date(date);
            return d.toISOString().slice(0, 7);
        };
        
        function getQuarterMonths(monthId) {
            if (!monthId) return [];
            const year = monthId.slice(0, 4);
            const month = parseInt(monthId.slice(5, 7), 10);
            if (month <= 3) return [`${year}-01`, `${year}-02`, `${year}-03`];
            if (month <= 6) return [`${year}-04`, `${year}-05`, `${year}-06`];
            if (month <= 9) return [`${year}-07`, `${year}-08`, `${year}-09`];
            return [`${year}-10`, `${year}-11`, `${year}-12`];
        }

        // --- EMPLOYEE CRUD ---
        function openEmployeeModal(employeeDbId = null) {
            employeeForm.reset();
            const modalTitle = document.getElementById('modalTitle');
            const employeeIdInput = document.getElementById('employeeIdInput');

            if (employeeDbId) {
                modalTitle.textContent = 'Edit Employee';
                const employee = processedData.employees.find(emp => emp.id == employeeDbId);
                if (employee) {
                    document.getElementById('employeeDbIdInput').value = employee.id;
                    employeeIdInput.value = employee.id;
                    employeeIdInput.readOnly = true;
                    employeeIdInput.classList.add('cursor-not-allowed', 'bg-gray-100', 'dark:bg-gray-700');

                    document.getElementById('employeeNameInput').value = employee.name;
                    document.getElementById('employeeEmailInput').value = employee.email;
                    document.getElementById('employeeDeptInput').value = employee.department;
                }
            } else {
                modalTitle.textContent = 'Add Employee';
                document.getElementById('employeeDbIdInput').value = '';
                employeeIdInput.readOnly = false;
                employeeIdInput.classList.remove('cursor-not-allowed', 'bg-gray-100', 'dark:bg-gray-700');
            }
            employeeModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
        }
        
        function closeEmployeeModal() {
            employeeModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
        }

        async function saveEmployee(event) {
            event.preventDefault();
            const employeeDbId = document.getElementById('employeeDbIdInput').value;
            const name = document.getElementById('employeeNameInput').value;
            const email = document.getElementById('employeeEmailInput').value;
            const department = document.getElementById('employeeDeptInput').value;
            const employeeId = document.getElementById('employeeIdInput').value;

            if (employeeDbId) { // Edit existing employee
                const employee = processedData.employees.find(emp => emp.id == employeeDbId);
                if (employee) {
                    employee.name = name;
                    employee.email = email;
                    employee.department = department;
                }
            } else { // Add new employee
                if (!employeeId) {
                    showUploadNotification('Employee ID is required.', true);
                    return;
                }
                
                const idExists = processedData.employees.some(emp => emp.id == employeeId);
                if (idExists) {
                    showUploadNotification('An employee with this ID already exists.', true);
                    return;
                }

                const newEmployee = {
                    id: Number(employeeId),
                    name,
                    email,
                    department,
                    daily: []
                };
                processedData.employees.push(newEmployee);
            }

            try {
                await setDoc(dataDocRef, processedData);
                showUploadNotification('Employee data saved successfully!');
                closeEmployeeModal();
                updateDashboard(document.getElementById('monthSelector').value);
            } catch (error) {
                console.error("Error saving employee data:", error);
                showUploadNotification(`Error: ${error.message}`, true);
            }
        }

        async function deleteEmployee(employeeDbId) {
            // Using custom modal for confirmation instead of window.confirm
            // For now, simple logic is used. A proper modal would be better.
            const confirmed = true; // Simulating confirmation
            if (!confirmed) return;

            processedData.employees = processedData.employees.filter(emp => emp.id != employeeDbId);

            try {
                await setDoc(dataDocRef, processedData);
                showUploadNotification('Employee deleted successfully!');
                showView('employeeTableView');
                updateDashboard(document.getElementById('monthSelector').value);
            } catch (error)
            {
                console.error("Error deleting employee:", error);
                showUploadNotification(`Error: ${error.message}`, true);
            }
        }

        // --- CORE LOGIC ---
        document.getElementById('excel_file').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const newRawData = XLSX.utils.sheet_to_json(worksheet);

                    if (newRawData.length === 0) throw new Error("Excel file is empty.");

                    const docSnap = await getDoc(dataDocRef);
                    const existingData = docSnap.exists() ? docSnap.data() : { employees: [] };

                    processedData = processRawData(newRawData, existingData);
                    await setDoc(dataDocRef, processedData);
                    populateMonthSelector(processedData.monthIds);
                    updateDashboard(processedData.thisMonthId);
                    showView('dashboardView');
                    showUploadNotification("Dashboard updated successfully!");
                } catch (error) {
                    console.error("Error processing Excel file:", error);
                    showUploadNotification(`Error: ${error.message}`, true);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function processRawData(newData, existingData) {
            const firstRow = newData[0];
            if (!firstRow) throw new Error("New Excel data is empty.");

            // Flexible column mapping
            const columnMappings = {
                'employee id': 'employeeId',
                'employee': 'employeeName',
                'email': 'email',
                'department': 'department',
                'date': 'date',
                'labor hours': 'hours',
                'billable amount': 'billable'
            };

            // Add all KPI keys to the mappings
            const optionalKpiKeys = kpis.map(k => k.key);
            optionalKpiKeys.forEach(key => {
                columnMappings[key.toLowerCase()] = key;
            });


            const actualColumns = Object.keys(firstRow).reduce((acc, col) => {
                acc[col.toLowerCase().trim()] = col;
                return acc;
            }, {});
            
            const resolvedColumns = {};
            for (const key in columnMappings) {
                if (actualColumns[key]) {
                    resolvedColumns[columnMappings[key]] = actualColumns[key];
                }
            }

            // Check for essential columns
            const essentialColumns = ['employeeId', 'employeeName', 'date', 'hours', 'billable'];
            for(const col of essentialColumns) {
                if(!resolvedColumns[col]) throw new Error(`Missing required column: One of the essential columns like 'Employee ID', 'Date', etc. is missing.`);
            }

            // Check for missing optional KPI columns and prepare warning
            const missingKpiColumns = optionalKpiKeys.filter(key => !resolvedColumns[key]);
            if (missingKpiColumns.length > 0 && missingKpiColumns.length < optionalKpiKeys.length) {
                setTimeout(() => { 
                    showUploadNotification(`Warning: Not all KPI columns were found. Missing: ${missingKpiColumns.join(', ')}.`, false, true);
                }, 1000);
            }

            const employeeData = (existingData && existingData.employees) ? existingData.employees.reduce((acc, emp) => {
                acc[emp.id] = emp;
                return acc;
            }, {}) : {};
            
            const duplicateDatesFound = new Set();
            newData.forEach(row => {
                const id = row[resolvedColumns.employeeId];
                if (!id || !employeeData[id]) return; 

                let date;
                const dateValue = row[resolvedColumns.date];
                if (typeof dateValue === 'number') {
                    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                    date = new Date(excelEpoch.getTime() + dateValue * 86400000);
                } else {
                    date = new Date(String(dateValue).split(' ')[0] + 'T00:00:00Z');
                }
                if (isNaN(date.getTime())) return;
                
                const dateStr = date.toISOString().split('T')[0];

                const hasExistingEntry = employeeData[id].daily.some(d => d.date === dateStr);
                if (hasExistingEntry) {
                    duplicateDatesFound.add(dateStr);
                }
            });

            if (duplicateDatesFound.size > 0) {
                const sortedDates = Array.from(duplicateDatesFound).sort().join(', ');
                throw new Error(`Upload blocked. Data for the following dates already exists: ${sortedDates}`);
            }

            newData.forEach(row => {
                const id = row[resolvedColumns.employeeId];
                if (!id) return;

                 if (!employeeData[id]) {
                     employeeData[id] = { 
                        id: id, 
                        name: row[resolvedColumns.employeeName], 
                        email: row[resolvedColumns.email] || '', 
                        department: row[resolvedColumns.department] || 'N/A', 
                        daily: [] 
                    };
                }

                let date;
                const dateValue = row[resolvedColumns.date];
                if (typeof dateValue === 'number') {
                    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                    date = new Date(excelEpoch.getTime() + dateValue * 86400000);
                } else {
                    date = new Date(String(dateValue).split(' ')[0] + 'T00:00:00Z');
                }

                if (isNaN(date.getTime())) return;

                const newEntry = {
                    date: date.toISOString().split('T')[0],
                    hours: Number(row[resolvedColumns.hours]) || 0,
                    billable: Number(row[resolvedColumns.billable]) || 0,
                };

                // Dynamically add all available KPI data
                optionalKpiKeys.forEach(key => {
                    if (resolvedColumns[key]) {
                        const value = row[resolvedColumns[key]];
                        newEntry[key] = (value !== null && value !== undefined && value !== '') ? Number(value) : null;
                    } else {
                        newEntry[key] = null;
                    }
                });
                
                employeeData[id].daily.push(newEntry);
            });

            const allDates = Object.values(employeeData).flatMap(emp => emp.daily.map(d => new Date(d.date)));
            const weekIds = [...new Set(allDates.map(d => getWeekId(d)))].filter(Boolean).sort().reverse();
            const monthIds = [...new Set(allDates.map(d => getMonthId(d)))].filter(Boolean).sort().reverse();

            return { employees: Object.values(employeeData), thisWeekId: weekIds[0], lastWeekId: weekIds[1] || null, thisMonthId: monthIds[0], monthIds };
        }

        function updateDashboard(monthId) {
            if (!processedData.employees || processedData.employees.length === 0) {
                 // Clear dashboard view if no data
                document.getElementById('totalEmployees').textContent = '0';
                document.getElementById('totalHours').textContent = '0';
                document.getElementById('totalBillable').textContent = '$0';
                document.getElementById('overtimeHours').textContent = '0';
                document.getElementById('totalHoursLabel').textContent = 'Total Hours';
                document.getElementById('totalBillableLabel').textContent = 'Total Billable';
                document.getElementById('overtimeHoursLabel').textContent = 'Overtime Hours';
                document.getElementById('employeeTableBody').innerHTML = '';
                 if (monthlyTrendChart) {
                    monthlyTrendChart.data.labels = [];
                    monthlyTrendChart.data.datasets[0].data = [];
                    monthlyTrendChart.update();
                }
                if(leaderboardList) leaderboardList.innerHTML = '<li>No data available.</li>';
                return;
            }

            if (!monthId) monthId = processedData.monthIds[0];
            if (!monthId) { // Still no monthId, clear everything
                 updateDashboard(null);
                 return;
            }


            const { employees } = processedData;
            const monthName = new Date(monthId + '-02T00:00:00Z').toLocaleString('default', { month: 'long', year: 'numeric' });

            document.getElementById('totalHoursLabel').textContent = `Total Hours (${monthName})`;
            document.getElementById('totalBillableLabel').textContent = `Total Billable (${monthName})`;
            document.getElementById('overtimeHoursLabel').textContent = `Overtime Hours (${monthName})`;
            document.getElementById('employeeTableHeader').textContent = `All Employees (${monthName})`;
            document.getElementById('employeeTableHoursHeader').textContent = `Hours (${monthName})`;
            document.getElementById('employeeTableBillableHeader').textContent = `Billable (${monthName})`;

            const monthData = employees.map(emp => {
                const monthEntries = emp.daily.filter(d => getMonthId(d.date) === monthId);
                return {
                    ...emp,
                    totalHours: monthEntries.reduce((sum, d) => sum + d.hours, 0),
                    totalBillable: monthEntries.reduce((sum, d) => sum + d.billable, 0)
                };
            });

            const totalHours = monthData.reduce((sum, emp) => sum + emp.totalHours, 0);
            const totalBillable = monthData.reduce((sum, emp) => sum + emp.totalBillable, 0);
            const overtimeHours = monthData.reduce((sum, emp) => sum + (emp.totalHours > 160 ? emp.totalHours - 160 : 0), 0);

            document.getElementById('totalEmployees').textContent = employees.length;
            document.getElementById('totalHours').textContent = totalHours.toFixed(2);
            document.getElementById('totalBillable').textContent = `$${totalBillable.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('overtimeHours').textContent = overtimeHours.toFixed(2);

            populateEmployeeTable(monthData);
            updateMainCharts({ employees, thisMonthId: monthId });
        }

        function populateEmployeeTable(data) {
            const tableBody = document.getElementById('employeeTableBody');
            tableBody.innerHTML = '';
            data.forEach(emp => {
                const tr = document.createElement('tr');
                tr.className = "cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50";
                tr.setAttribute('data-employee-id', emp.id);
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${emp.name}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">${emp.email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap hidden sm:table-cell"><div class="text-sm text-gray-900 dark:text-white">${emp.department}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900 dark:text-white">${emp.totalHours.toFixed(2)}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap hidden md:table-cell"><div class="text-sm text-gray-900 dark:text-white">$${emp.totalBillable.toLocaleString(undefined, {minimumFractionDigits: 2})}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="edit-btn text-primary hover:text-indigo-700 mr-3" data-id="${emp.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn text-danger hover:text-red-700" data-id="${emp.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                 // Add click event listener to the whole row for navigating to the profile
                tr.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return; // Don't navigate if a button was clicked
                    const selectedMonth = document.getElementById('monthSelector').value;
                    showEmployeeProfile(emp.id, selectedMonth);
                });

                tableBody.appendChild(tr);
            });
        }

        function updateMainCharts({ employees, thisMonthId }) {
            // Leaderboard
            const leaderboardList = document.getElementById('leaderboardList');
            const leaderboardTitle = document.getElementById('leaderboardTitle');
            leaderboardList.innerHTML = '';

            const allDates = employees.flatMap(emp => emp.daily.map(d => d.date)).sort();
            const latestDateStr = allDates[allDates.length - 1];

            if(latestDateStr) {
                leaderboardTitle.textContent = `Daily Hours Leaderboard (${latestDateStr})`;
                const leaderboardData = employees.map(emp => {
                    const dayEntry = emp.daily.find(d => d.date === latestDateStr);
                    return {
                        name: emp.name,
                        hours: dayEntry ? dayEntry.hours : 0
                    };
                })
                .filter(emp => emp.hours > 0.1)
                .sort((a, b) => b.hours - a.hours);

                if (leaderboardData.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'text-sm text-gray-500 dark:text-gray-400';
                    li.textContent = 'No employees with recorded hours for this day.';
                    leaderboardList.appendChild(li);
                } else {
                    leaderboardData.forEach(emp => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center text-sm';
                        const hoursColorClass = emp.hours < 8 ? 'text-red-500' : 'text-primary dark:text-indigo-400';
                        li.innerHTML = `<span class="text-gray-800 dark:text-gray-200">${emp.name}</span><span class="font-bold ${hoursColorClass}">${emp.hours.toFixed(2)} hrs</span>`;
                        leaderboardList.appendChild(li);
                    });
                }
            } else {
                leaderboardTitle.textContent = 'Daily Hours Leaderboard';
                const li = document.createElement('li');
                li.className = 'text-sm text-gray-500 dark:text-gray-400';
                li.textContent = 'No data available.';
                leaderboardList.appendChild(li);
            }


            // Monthly Trend Chart
            const monthlyTotals = {};
            employees.forEach(emp => {
                emp.daily.forEach(day => {
                    if (getMonthId(day.date) === thisMonthId) {
                        if (!monthlyTotals[day.date]) monthlyTotals[day.date] = 0;
                        monthlyTotals[day.date] += day.hours;
                    }
                });
            });

            const sortedDates = Object.keys(monthlyTotals).sort();
            monthlyTrendChart.data.labels = sortedDates;
            monthlyTrendChart.data.datasets[0].data = sortedDates.map(date => monthlyTotals[date]);
            monthlyTrendChart.update();
        }

        function showEmployeeProfile(employeeId, monthId) {
            const employee = processedData.employees.find(emp => emp.id == employeeId);
            if (!employee) return;

            const employeeMonthIds = [...new Set(employee.daily.map(d => getMonthId(d.date)))].filter(Boolean).sort().reverse();
            const selector = document.getElementById('employeeMonthSelector');
            selector.innerHTML = '';
            employeeMonthIds.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = new Date(id + '-02T00:00:00Z').toLocaleString('default', { month: 'long', year: 'numeric' });
                selector.appendChild(option);
            });
            selector.value = monthId;

            document.getElementById('employeeProfileView').dataset.currentEmployeeId = employeeId;

            updateEmployeeProfileView(employee, monthId);

            showView('employeeProfileView');
        }

        function updateEmployeeProfileView(employee, monthId) {
            const monthName = new Date(monthId + '-02T00:00:00Z').toLocaleString('default', { month: 'long', year: 'numeric' });
            document.getElementById('employeeHoursLabel').textContent = `Hours (${monthName})`;
            document.getElementById('employeeBillableLabel').textContent = `Billable (${monthName})`;
            document.getElementById('employeeAvgHoursLabel').textContent = `Avg Daily Hours (${monthName})`;

            const monthEntries = employee.daily.filter(d => getMonthId(d.date) === monthId);
            const monthHours = monthEntries.reduce((sum, d) => sum + d.hours, 0);
            const monthBillable = monthEntries.reduce((sum, d) => sum + d.billable, 0);
            const daysWithHours = monthEntries.filter(d => d.hours > 0).length;
            const avgHours = daysWithHours > 0 ? (monthHours / daysWithHours) : 0;

            document.getElementById('employeeNameTitle').textContent = `${employee.name}'s Profile`;
            document.getElementById('employeeProfileName').textContent = employee.name;
            document.getElementById('employeeProfileDept').textContent = employee.department;
            document.getElementById('employeeProfileId').textContent = employee.id;
            document.getElementById('employeeProfileEmail').textContent = employee.email;
            document.getElementById('employeeHoursThisMonth').textContent = monthHours.toFixed(2);
            document.getElementById('employeeBillableThisMonth').textContent = `$${monthBillable.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('employeeAvgHoursThisMonth').textContent = avgHours.toFixed(2);


            const year = parseInt(monthId.split('-')[0]);
            const month = parseInt(monthId.split('-')[1]) - 1;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const labels = [];
            const data = Array(daysInMonth).fill(0);

            for (let i = 1; i <= daysInMonth; i++) {
                labels.push(new Date(Date.UTC(year, month, i)));
            }

            monthEntries.forEach(d => {
                const dayOfMonth = new Date(d.date + 'T00:00:00Z').getUTCDate();
                data[dayOfMonth - 1] = d.hours;
            });

            dailyHoursChart.data.labels = labels;
            dailyHoursChart.data.datasets[0].data = data;
            dailyHoursChart.update();
        }
        
        function generateReports() {
            const monthId = document.getElementById('monthSelector').value;
            if (!monthId || !processedData.employees) {
                return;
            }

            const year = parseInt(monthId.split('-')[0]);
            const month = parseInt(monthId.split('-')[1]) - 1;
            const monthName = new Date(year, month).toLocaleString('default', { month: 'short' });
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Monthly Report
            const monthlyReportContainer = document.getElementById('monthlyReportContainer');
            const lastDayOfMonth = new Date(Date.UTC(year, month, daysInMonth)).toISOString().split('T')[0];

            const allDatesForMonth = new Set(
                processedData.employees.flatMap(emp => 
                    emp.daily.filter(d => getMonthId(d.date) === monthId).map(d => d.date)
                )
            );

            if (allDatesForMonth.has(lastDayOfMonth)) {
                let tableHtml = `
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Employee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Avg Daily Hours</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                `;
                processedData.employees.forEach(emp => {
                    const monthEntries = emp.daily.filter(d => getMonthId(d.date) === monthId);
                    const monthHours = monthEntries.reduce((sum, d) => sum + d.hours, 0);
                    const daysWithHours = monthEntries.filter(d => d.hours > 0).length;
                    const avgHours = daysWithHours > 0 ? (monthHours / daysWithHours) : 0;
                    tableHtml += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${emp.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${avgHours.toFixed(2)}</td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;
                monthlyReportContainer.innerHTML = tableHtml;
            } else {
                monthlyReportContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400">The report for ${new Date(monthId + '-02T00:00:00Z').toLocaleString('default', { month: 'long', year: 'numeric' })} will be generated once data for the entire month has been imported.</p>`;
            }

            // Bi-Weekly Report based on 15/16 day periods
            const biWeeklyReportContainer = document.getElementById('biWeeklyReportContainer');
            const allMonthlyData = processedData.employees.flatMap(emp => 
                emp.daily
                   .filter(d => getMonthId(d.date) === monthId)
                   .map(d => ({...d, employeeName: emp.name}))
            ).sort((a,b) => new Date(a.date) - new Date(b.date));
            
            if(allMonthlyData.length > 0) {
                const periodData = {};

                allMonthlyData.forEach(entry => {
                    const dayOfMonth = new Date(entry.date + 'T00:00:00Z').getUTCDate();
                    const periodKey = dayOfMonth <= 15 ? 1 : 2;
                    
                    if (!periodData[periodKey]) {
                        periodData[periodKey] = {};
                    }
                    if (!periodData[periodKey][entry.employeeName]) {
                        periodData[periodKey][entry.employeeName] = { totalHours: 0, days: 0 };
                    }
                    if (entry.hours > 0) {
                        periodData[periodKey][entry.employeeName].totalHours += entry.hours;
                        periodData[periodKey][entry.employeeName].days += 1;
                    }
                });

                let biWeeklyTableHtml = '';
                const period1Label = `${monthName} 1 - ${monthName} 15`;
                const period2Label = `${monthName} 16 - ${monthName} ${daysInMonth}`;

                [ {label: period1Label, data: periodData[1]}, {label: period2Label, data: periodData[2]} ].forEach(period => {
                    if (period.data) {
                        biWeeklyTableHtml += `<h4 class="font-semibold text-md text-gray-800 dark:text-gray-200 mt-6 mb-2">${period.label}</h4>`;
                        biWeeklyTableHtml += `
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Employee</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Avg Daily Hours</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        `;
                        Object.keys(period.data).sort().forEach(employeeName => {
                            const empData = period.data[employeeName];
                            const avg = empData.days > 0 ? empData.totalHours / empData.days : 0;
                            biWeeklyTableHtml += `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${employeeName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${avg.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                        biWeeklyTableHtml += `</tbody></table>`;
                    }
                });
                
                biWeeklyReportContainer.innerHTML = biWeeklyTableHtml || `<p class="text-gray-500 dark:text-gray-400">No data available for the selected month to generate bi-weekly reports.</p>`;

            } else {
                 biWeeklyReportContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400">No data available for the selected month to generate bi-weekly reports.</p>`;
            }
        }


        function populateMonthSelector(monthIds) {
            const selector = document.getElementById('monthSelector');
            selector.innerHTML = '';
            if (!monthIds || monthIds.length === 0) return;
            monthIds.forEach(monthId => {
                const option = document.createElement('option');
                option.value = monthId;
                option.textContent = new Date(monthId + '-02T00:00:00Z').toLocaleString('default', { month: 'long', year: 'numeric' });
                selector.appendChild(option);
            });
        }
        
        function populateKpiMonthSelector() {
            const selector = document.getElementById('kpiMonthSelector');
            const mainMonthSelectorValue = document.getElementById('monthSelector').value;
            selector.innerHTML = '';
             if (processedData.monthIds && processedData.monthIds.length > 0) {
                processedData.monthIds.forEach(monthId => {
                    const option = document.createElement('option');
                    option.value = monthId;
                    option.textContent = new Date(monthId + '-02T00:00:00Z').toLocaleString('default', { month: 'long', year: 'numeric' });
                    selector.appendChild(option);
                });
                selector.value = mainMonthSelectorValue;
            }
        }

        // --- PERFORMANCE/KPI VIEW LOGIC ---
        function populateKpiReferenceTable() {
            const tableBody = document.getElementById('kpiReferenceTableBody');
            tableBody.innerHTML = '';
            kpis.forEach(kpi => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${kpi.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${kpi.measure}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${kpi.target}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${kpi.weight}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function populateKpiEmployeeSelector() {
            const selector = document.getElementById('kpiEmployeeSelector');
            selector.innerHTML = '<option value="">-- Select Employee --</option>';
            if (processedData.employees) {
                processedData.employees.sort((a, b) => a.name.localeCompare(b.name)).forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.name;
                    selector.appendChild(option);
                });
            }
        }
        
        function getKpiStatusHtml(targetMet) {
             return targetMet 
                ? '<span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Target Met</span>'
                : '<span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Needs Improvement</span>';
        }

        function getKpiRangeStatusHtml(isMet, isUnder) {
            if (isMet) {
                return '<span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">On Target</span>';
            }
            return `<span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">${isUnder ? 'Below Target' : 'Above Target'}</span>`;
        }

        function displayEmployeeKpis(employeeId, monthId, timeFrame = 'monthly') {
            const container = document.getElementById('employeeKpiContainer');
            container.innerHTML = ''; // Clear previous data

            if (!employeeId || !monthId) {
                container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center py-8">Select an employee and ensure data is loaded to view performance analysis.</p>`;
                return;
            }

            const employee = processedData.employees.find(emp => emp.id == employeeId);
            if (!employee) return;

            let relevantEntries = [];
            if (timeFrame === 'quarterly') {
                const quarterMonths = getQuarterMonths(monthId);
                relevantEntries = employee.daily.filter(d => quarterMonths.includes(getMonthId(d.date)));
            } else { // monthly
                relevantEntries = employee.daily.filter(d => getMonthId(d.date) === monthId);
            }
            
            // --- KPI Calculations ---
            const kpiValues = {};
            
            // Special handling for billableHours, which is a sum of 'hours', not a distinct metric from the file.
            kpiValues['billableHours'] = relevantEntries.reduce((sum, entry) => sum + (entry.hours || 0), 0);
            
            kpis.forEach(kpi => {
                // Skip billableHours as it's already calculated
                if (kpi.key === 'billableHours') return;

                const entries = relevantEntries.map(d => d[kpi.key]).filter(v => v !== null && v !== undefined);
                
                // Check if there's any data for this KPI
                if (entries.length === 0) {
                    kpiValues[kpi.key] = null;
                    return;
                }

                if (['partsDelay', 'toolLoss', 'trainingHours'].includes(kpi.key)) { // SUM KPIs
                     kpiValues[kpi.key] = entries.reduce((a, b) => a + b, 0);
                } else { // AVERAGE KPIs
                    kpiValues[kpi.key] = entries.reduce((a, b) => a + b, 0) / entries.length;
                }
            });

            const kpisByCategory = kpis.reduce((acc, kpi) => {
                if (!acc[kpi.category]) acc[kpi.category] = [];
                acc[kpi.category].push(kpi);
                return acc;
            }, {});

            let html = '';
            for (const category in kpisByCategory) {
                html += `<div class="mb-6"><h4 class="font-medium text-md text-gray-800 dark:text-gray-200 mb-3">${category}</h4>`;
                html += '<ul class="space-y-3">';

                kpisByCategory[category].forEach(kpi => {
                    let actualValue = 'N/A';
                    let statusHtml = '<span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">No Data</span>';
                    let progressBarHtml = '';
                    const value = kpiValues[kpi.key];
                    let targetMet = false;

                    if (value !== null && !isNaN(value)) {
                        let progressPercent = 0;
                        let progressColor = 'bg-gray-400';

                        switch(kpi.key) {
                            case 'billableHours':
                                actualValue = `${value.toFixed(2)} hrs`;
                                const monthlyTargetHours = 140;
                                const targetHours = timeFrame === 'quarterly' ? monthlyTargetHours * 3 : monthlyTargetHours;
                                targetMet = value >= targetHours;
                                progressPercent = Math.min((value / targetHours) * 100, 100);
                                progressColor = targetMet ? 'bg-green-500' : 'bg-yellow-500';
                                statusHtml = getKpiStatusHtml(targetMet);
                                break;
                            case 'fixRate': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value >= 90; 
                                progressPercent = Math.min((value / 90) * 100, 100);
                                progressColor = targetMet ? 'bg-green-500' : 'bg-red-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'reworkRate': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value <= 5; 
                                progressPercent = Math.max(0, 100 - ((value / 5) * 100));
                                progressColor = targetMet ? 'bg-green-500' : 'bg-red-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'jobsPerShift': 
                                actualValue = `${value.toFixed(2)} jobs`; 
                                targetMet = value >= 4 && value <= 6; 
                                progressPercent = (value / 6) * 100;
                                progressColor = targetMet ? 'bg-green-500' : (value < 4 ? 'bg-red-500' : 'bg-yellow-500');
                                statusHtml = getKpiRangeStatusHtml(targetMet, value < 4); 
                                break;
                            case 'completionTime': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value >= 90; 
                                progressPercent = Math.min((value / 90) * 100, 100);
                                progressColor = targetMet ? 'bg-green-500' : 'bg-red-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'docAccuracy': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value === 100; 
                                progressPercent = value;
                                progressColor = targetMet ? 'bg-green-500' : 'bg-yellow-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'submitTime': 
                                actualValue = `${value.toFixed(2)} hrs`; 
                                targetMet = value <= 1; 
                                progressPercent = Math.max(0, 100 - (value * 100));
                                progressColor = targetMet ? 'bg-green-500' : 'bg-red-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'toolLoss': 
                                actualValue = `${value} incidents`; 
                                targetMet = value === 0; 
                                progressPercent = value === 0 ? 100 : 0;
                                progressColor = targetMet ? 'bg-green-500' : 'bg-red-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'equipChecks': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value === 100; 
                                progressPercent = value;
                                progressColor = targetMet ? 'bg-green-500' : 'bg-yellow-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'inventoryMatch': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value >= 95; 
                                progressPercent = (value/95) * 100;
                                progressColor = targetMet ? 'bg-green-500' : 'bg-yellow-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'onTimeArrival': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value >= 95; 
                                progressPercent = (value/95) * 100;
                                progressColor = targetMet ? 'bg-green-500' : 'bg-red-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'jobsInWindow': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value >= 90; 
                                progressPercent = (value/90) * 100;
                                progressColor = targetMet ? 'bg-green-500' : 'bg-yellow-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'travelTime': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value < 30; 
                                progressPercent = Math.max(0, 100 - ((value/30)*100));
                                progressColor = targetMet ? 'bg-green-500' : 'bg-red-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'packingAccuracy': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value >= 98; 
                                progressPercent = (value/98)*100;
                                progressColor = targetMet ? 'bg-green-500' : 'bg-yellow-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'partsDelay': 
                                actualValue = `${value} delays`; 
                                targetMet = value <= 2; 
                                progressPercent = Math.max(0, 100 - ((value/2)*100));
                                progressColor = targetMet ? 'bg-green-500' : 'bg-red-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'partsPrepTime': 
                                actualValue = `${value.toFixed(2)} mins`; 
                                targetMet = value <= 15; 
                                progressPercent = Math.max(0, 100 - ((value/15)*100));
                                progressColor = targetMet ? 'bg-green-500' : 'bg-yellow-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'partsChecklist': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value === 100; 
                                progressPercent = value;
                                progressColor = targetMet ? 'bg-green-500' : 'bg-yellow-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'trainingHours': 
                                actualValue = `${value} hrs`; 
                                const quarterlyTarget = 8;
                                const monthlyTarget = quarterlyTarget / 3;
                                const currentTarget = timeFrame === 'quarterly' ? quarterlyTarget : monthlyTarget;
                                targetMet = value >= currentTarget;
                                progressPercent = Math.min((value / currentTarget) * 100, 100);
                                progressColor = targetMet ? 'bg-green-500' : 'bg-yellow-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'upsellConversion': 
                                actualValue = `${value.toFixed(2)}%`; 
                                targetMet = value >= 30; 
                                progressPercent = Math.min((value / 30) * 100, 100);
                                progressColor = targetMet ? 'bg-green-500' : 'bg-yellow-500';
                                statusHtml = getKpiStatusHtml(targetMet); 
                                break;
                            case 'upsellRevenue': 
                                actualValue = `$${value.toFixed(2)}`; 
                                statusHtml = '<span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">Manual Review</span>'; 
                                break;
                            case 'certifications': 
                                actualValue = `${value}`; 
                                statusHtml = '<span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">Manual Review</span>'; 
                                break;
                        }

                        if (progressPercent > 0) {
                             progressBarHtml = `
                                <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700 mt-2">
                                    <div class="${progressColor} h-2 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>
                            `;
                        }
                    }

                    html += `
                        <li class="p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">${kpi.measure}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Target: ${kpi.target}</p>
                                </div>
                                <div class="text-right flex-shrink-0 ml-4">
                                     <p class="text-sm font-semibold text-gray-900 dark:text-white">${actualValue}</p>
                                     ${statusHtml}
                                </div>
                            </div>
                            ${progressBarHtml}
                        </li>
                    `;
                });
                html += '</ul></div>';
            }
            container.innerHTML = html;
        }


        function showView(viewId) {
            const pageTitles = { dashboardView: 'Dashboard Overview', employeeTableView: 'Employees', employeeProfileView: 'Employee Profile', performanceView: 'Performance', reportsView: 'Reports', settingsView: 'Settings' };
            document.getElementById('pageTitle').textContent = pageTitles[viewId] || 'Dashboard';
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            navLinks.forEach(link => link.classList.toggle('active', link.dataset.view === viewId));
            
            // Close mobile sidebar on navigation
            sidebar.classList.remove('open');
            sidebarOverlay.classList.add('hidden');


            if(viewId === 'reportsView') {
                generateReports();
            }
            if(viewId === 'performanceView') {
                document.querySelectorAll('#kpiTimeFrameSelector button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === 'monthly');
                });
                populateKpiMonthSelector();
                populateKpiEmployeeSelector();
                const selectedEmployee = document.getElementById('kpiEmployeeSelector').value;
                const selectedMonth = document.getElementById('kpiMonthSelector').value;
                displayEmployeeKpis(selectedEmployee, selectedMonth, 'monthly');
            }
        }

        // --- UI INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', async function() {
            populateKpiReferenceTable();

            const chartOptions = { responsive: true, maintainAspectRatio: false };
            const timeScaleOptions = { ...chartOptions, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM d' } } } };

            monthlyTrendChart = new Chart(document.getElementById('monthlyTrendChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'Total Hours', data: [], borderColor: '#4F46E5', tension: 0.1, pointBackgroundColor: '#4F46E5' }] }, options: timeScaleOptions });
            dailyHoursChart = new Chart(document.getElementById('dailyHoursChart').getContext('2d'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Labor Hours', data: [], backgroundColor: '#4F46E5', borderRadius: 4 }] }, options: timeScaleOptions });

            // Sidebar toggles
            document.getElementById('toggleSidebar').addEventListener('click', () => sidebar.classList.toggle('collapsed'));
            document.getElementById('mobileMenuButton').addEventListener('click', () => {
                sidebar.classList.add('open');
                sidebarOverlay.classList.remove('hidden');
            });
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.add('hidden');
            });


            navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); if (link.dataset.view) showView(link.dataset.view); }));
            document.getElementById('backToEmployeeList').addEventListener('click', () => showView('employeeTableView'));

             document.getElementById('employeeTableBody').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (editBtn) {
                    e.stopPropagation();
                    const employeeDbId = editBtn.dataset.id;
                    openEmployeeModal(employeeDbId);
                } else if (deleteBtn) {
                    e.stopPropagation();
                    const employeeDbId = deleteBtn.dataset.id;
                    deleteEmployee(employeeDbId);
                }
            });
            
            document.getElementById('editProfileBtn').addEventListener('click', () => {
                const employeeId = document.getElementById('employeeProfileView').dataset.currentEmployeeId;
                if (employeeId) {
                    openEmployeeModal(employeeId);
                }
            });

            document.getElementById('deleteProfileBtn').addEventListener('click', () => {
                const employeeId = document.getElementById('employeeProfileView').dataset.currentEmployeeId;
                if (employeeId) {
                    // This is a simple confirmation. A better UX would be a custom modal.
                    if (confirm('Are you sure you want to delete this employee profile? This action is irreversible.')) {
                        deleteEmployee(employeeId);
                    }
                }
            });

            document.getElementById('addEmployeeBtn').addEventListener('click', () => openEmployeeModal());
            document.getElementById('closeModal').addEventListener('click', closeEmployeeModal);
            employeeForm.addEventListener('submit', saveEmployee);


            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                if (!processedData.employees) return;

                showView('employeeTableView');

                const searchTerm = e.target.value.toLowerCase().trim();
                const dateRegex = /^\d{4}-\d{2}-\d{2}$/;

                if (dateRegex.test(searchTerm)) {
                    const date = searchTerm;
                    document.getElementById('employeeTableHeader').textContent = `Employee Stats for ${date}`;
                    document.getElementById('employeeTableHoursHeader').textContent = `Hours (${date})`;
                    document.getElementById('employeeTableBillableHeader').textContent = `Billable (${date})`;

                    const dailyData = processedData.employees.map(emp => {
                        const dayEntry = emp.daily.find(d => d.date === date);
                        return {
                            ...emp,
                            totalHours: dayEntry ? dayEntry.hours : 0,
                            totalBillable: dayEntry ? dayEntry.billable : 0
                        };
                    });
                    populateEmployeeTable(dailyData);
                } else {
                    const selectedMonth = document.getElementById('monthSelector').value;
                    const monthName = new Date(selectedMonth + '-02T00:00:00Z').toLocaleString('default', { month: 'long', year: 'numeric' });

                    document.getElementById('employeeTableHeader').textContent = `All Employees (${monthName})`;
                    document.getElementById('employeeTableHoursHeader').textContent = `Hours (${monthName})`;
                    document.getElementById('employeeTableBillableHeader').textContent = `Billable (${monthName})`;

                    const filteredData = processedData.employees.filter(emp =>
                        emp.name.toLowerCase().includes(searchTerm) ||
                        String(emp.id).toLowerCase().includes(searchTerm) ||
                        (emp.department && emp.department.toLowerCase().includes(searchTerm))
                    );

                    const monthData = filteredData.map(emp => {
                        const monthEntries = emp.daily.filter(d => getMonthId(d.date) === selectedMonth);
                        return {
                            ...emp,
                            totalHours: monthEntries.reduce((s, d) => s + d.hours, 0),
                            totalBillable: monthEntries.reduce((s, d) => s + d.billable, 0)
                        };
                    });
                    populateEmployeeTable(monthData);
                }
            });

            document.getElementById('monthSelector').addEventListener('change', (e) => {
                updateDashboard(e.target.value)
                const kpiMonthSelector = document.getElementById('kpiMonthSelector');
                if (kpiMonthSelector) {
                    kpiMonthSelector.value = e.target.value;
                }
                if (!document.getElementById('performanceView').classList.contains('hidden')) {
                     const selectedEmployee = document.getElementById('kpiEmployeeSelector').value;
                     const selectedTimeFrame = document.querySelector('#kpiTimeFrameSelector .kpi-time-btn.active')?.dataset.value || 'monthly';
                     displayEmployeeKpis(selectedEmployee, e.target.value, selectedTimeFrame);
                }
            });
            
            document.getElementById('kpiEmployeeSelector').addEventListener('change', (e) => {
                 const selectedMonth = document.getElementById('kpiMonthSelector').value;
                 const selectedTimeFrame = document.querySelector('#kpiTimeFrameSelector .kpi-time-btn.active')?.dataset.value || 'monthly';
                 displayEmployeeKpis(e.target.value, selectedMonth, selectedTimeFrame);
            });
            
            document.getElementById('kpiMonthSelector').addEventListener('change', (e) => {
                 const selectedEmployee = document.getElementById('kpiEmployeeSelector').value;
                 const selectedTimeFrame = document.querySelector('#kpiTimeFrameSelector .kpi-time-btn.active')?.dataset.value || 'monthly';
                 displayEmployeeKpis(selectedEmployee, e.target.value, selectedTimeFrame);
            });

            const kpiTimeFrameSelector = document.getElementById('kpiTimeFrameSelector');
            kpiTimeFrameSelector.addEventListener('click', (e) => {
                const button = e.target.closest('.kpi-time-btn');
                if (button) {
                    kpiTimeFrameSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    const selectedEmployee = document.getElementById('kpiEmployeeSelector').value;
                    const selectedMonth = document.getElementById('kpiMonthSelector').value;
                    const selectedTimeFrame = button.dataset.value;
                    displayEmployeeKpis(selectedEmployee, selectedMonth, selectedTimeFrame);
                }
            });

            document.getElementById('employeeMonthSelector').addEventListener('change', (e) => {
                const employeeId = document.getElementById('employeeProfileView').dataset.currentEmployeeId;
                const employee = processedData.employees.find(emp => emp.id == employeeId);
                if (employee) {
                    updateEmployeeProfileView(employee, e.target.value);
                }
            });

            document.getElementById('changePasswordForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const statusEl = document.getElementById('passwordChangeStatus');

                if (newPassword.length < 6) {
                    statusEl.textContent = "Password should be at least 6 characters.";
                    statusEl.className = "text-sm text-center text-red-500";
                    return;
                }

                if (newPassword !== confirmPassword) {
                    statusEl.textContent = "Passwords do not match.";
                    statusEl.className = "text-sm text-center text-red-500";
                    return;
                }

                updatePassword(auth.currentUser, newPassword).then(() => {
                    statusEl.textContent = "Password updated successfully!";
                    statusEl.className = "text-sm text-center text-green-500";
                    document.getElementById('changePasswordForm').reset();
                }).catch((error) => {
                    statusEl.textContent = `Error: ${error.message}`;
                    statusEl.className = "text-sm text-center text-red-500";
                });
            });

            // --- THEME TOGGLE LOGIC ---
            const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
            const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
            const themeToggleButton = document.getElementById('theme-toggle');

            const setTheme = (isDark) => {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    themeToggleLightIcon.classList.remove('hidden');
                    themeToggleDarkIcon.classList.add('hidden');
                    localStorage.setItem('color-theme', 'dark');
                    Chart.defaults.borderColor = 'rgba(107, 114, 128, 0.5)';
                    Chart.defaults.color = '#d1d5db';
                } else {
                    document.documentElement.classList.remove('dark');
                    themeToggleLightIcon.classList.add('hidden');
                    themeToggleDarkIcon.classList.remove('hidden');
                    localStorage.setItem('color-theme', 'light');
                    Chart.defaults.borderColor = 'rgba(229, 231, 235, 1)';
                    Chart.defaults.color = '#6b7280';
                }
                if (monthlyTrendChart) {
                    monthlyTrendChart.update();
                    dailyHoursChart.update();
                }
            };

            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                setTheme(true);
            } else {
                setTheme(false);
            }

            themeToggleButton.addEventListener('click', () => {
                setTheme(!document.documentElement.classList.contains('dark'));
            });

            // --- AUTHENTICATION LOGIC ---
            const loginView = document.getElementById('loginView');
            const appView = document.getElementById('appView');
            const loginForm = document.getElementById('loginForm');
            const loginButton = document.getElementById('loginButton');
            const showSignUp = document.getElementById('showSignUp');
            const authError = document.getElementById('authError');
            const logoutButton = document.getElementById('logoutButton');

            let isSignUp = false;

            showSignUp.addEventListener('click', (e) => {
                e.preventDefault();
                isSignUp = !isSignUp;
                loginButton.textContent = isSignUp ? 'Sign Up' : 'Sign In';
                document.querySelector('#loginView h2').textContent = isSignUp ? 'Create an Account' : 'Welcome to LaborTrack';
                document.querySelector('#loginView p').textContent = isSignUp ? 'Fill out the form to get started' : 'Sign in to continue';
                showSignUp.textContent = isSignUp ? 'Back to Sign In' : 'Sign Up';
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = loginForm.email.value;
                const password = loginForm.password.value;
                authError.classList.add('hidden');

                if (isSignUp) {
                    createUserWithEmailAndPassword(auth, email, password)
                        .catch(error => {
                            authError.textContent = error.message;
                            authError.classList.remove('hidden');
                        });
                } else {
                    signInWithEmailAndPassword(auth, email, password)
                        .catch(error => {
                            authError.textContent = error.message;
                            authError.classList.remove('hidden');
                        });
                }
            });

            logoutButton.addEventListener('click', () => {
                signOut(auth);
            });

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('lastLoginTime').textContent = new Date(user.metadata.lastSignInTime).toLocaleString();

                    try {
                        const docSnap = await getDoc(dataDocRef);
                        if (docSnap.exists() && docSnap.data().employees) {
                            processedData = docSnap.data();
                           if (!processedData.monthIds || processedData.monthIds.length === 0) {
                               const allDates = processedData.employees.flatMap(emp => emp.daily.map(d => new Date(d.date)));
                               processedData.monthIds = [...new Set(allDates.map(d => getMonthId(d)))].filter(Boolean).sort().reverse();
                               processedData.thisMonthId = processedData.monthIds[0];
                           }
                           populateMonthSelector(processedData.monthIds);
                           updateDashboard(processedData.thisMonthId);
                        } else {
                            // If no data exists in Firestore, initialize with an empty employees array
                            processedData = { employees: [], monthIds: [], thisMonthId: null };
                            populateMonthSelector([]);
                            updateDashboard(null);
                        }
                    } catch(e) {
                        console.error("Could not load data from Firestore:", e);
                        showUploadNotification("Could not load cloud data. Please check your connection.", true);
                    }
                    showView('dashboardView');
                } else {
                    // User is signed out
                    loginView.classList.remove('hidden');
                    appView.classList.add('hidden');
                    processedData = {};
                    updateDashboard(null); // Clear dashboard
                }
            });
        });
    </script>
</body>
</html>
